name: Auto-Process Lessons & Generate Tests

on:
  push:
    paths:
      - 'lessons/source/**'
  workflow_dispatch:
    inputs:
      force_generate:
        description: 'Force regenerate all quizzes'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_MODEL_QUIZ: ${{ vars.HF_MODEL_QUIZ || 'mistralai/Mixtral-8x22B-Instruct-v0.1' }}
      NODE_OPTIONS: "--max-old-space-size=4096"
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è CI
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ PWA –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è PWA Builder)
      - name: Check PWA manifest
        run: |
          if [ ! -s public/manifest.json ]; then
            echo "‚ùå public/manifest.json –ø—É—Å—Ç –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
            exit 1
          fi
          node -e "
            try { 
              const manifest = JSON.parse(require('fs').readFileSync('public/manifest.json', 'utf8'));
              if (!manifest.name || !manifest.icons || !manifest.start_url) {
                throw new Error('–ú–∞–Ω–∏—Ñ–µ—Å—Ç –Ω–µ–ø–æ–ª–Ω—ã–π');
              }
              console.log('‚úÖ Manifest valid:', manifest.name);
            } catch(e) { 
              console.error('‚ùå Manifest invalid:', e.message); 
              process.exit(1); 
            }
          "
      
      # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ sw.js –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (next-pwa –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –µ–≥–æ)
      - name: Check no manual SW
        run: |
          if [ -f public/sw.js ]; then
            echo "‚ùå public/sw.js –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!"
            echo "–£–¥–∞–ª–∏—Ç–µ –µ–≥–æ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
            exit 1
          fi
          echo "‚úÖ No manual service worker"
      
      # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ HF_TOKEN (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ)
      - name: Validate HF_TOKEN
        id: validate_token
        run: npm run validate-token
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        continue-on-error: true
      
      # ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–∫–æ–≤ –∏–∑ DOCX
      - name: Generate lessons from DOCX
        run: npm run generate-lessons
      
      # ‚úÖ –û—Ç–ª–∞–¥–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∏
      - name: Debug lessons
        run: |
          echo "üìö Generated lessons:"
          ls -la public/lessons/
          echo "Markdown files: $(find public/lessons -name \"*.md\" -type f | wc -l)"
      
      # ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º —Ñ–ª–∞–≥–∞ force
      - name: Generate quizzes
        run: |
          if [ "${{ github.event.inputs.force_generate }}" == "true" ]; then
            npm run generate-quizzes -- --force
          else
            npm run generate-quizzes
          fi
        timeout-minutes: 30
      
      # ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      - name: Verify quizzes
        run: |
          echo "üìù Generated quizzes:"
          ls -la public/content/quizzes/
          QUIZ_COUNT=$(find public/content/quizzes -name "*-quiz.json" -type f | wc -l)
          echo "Quiz files: $QUIZ_COUNT"
          for file in public/content/quizzes/*-quiz.json; do
            if [ -f "$file" ]; then
              node -e "
                try {
                  const data = JSON.parse(require('fs').readFileSync('$file', 'utf8'));
                  if (Array.isArray(data) && data.length > 0) {
                    console.log('  ‚úÖ', require('path').basename('$file'), ':', data.length, 'questions');
                  } else {
                    console.log('  ‚ö†Ô∏è', require('path').basename('$file'), ':', 'empty or invalid');
                  }
                } catch(e) {
                  console.error('  ‚ùå', require('path').basename('$file'), ':', e.message);
                }
              "
            fi
          done
      
      # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
      - name: Auto-commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ü§ñ Auto: processed lessons + Quiz tests"
          file_pattern: "public/lessons/ public/content/quizzes/ README.md"
          commit_author: "GitHub Actions <actions@github.com>"
          push_options: '--force-with-lease'
      
      # ‚úÖ –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      - name: Summary
        if: always()
        run: |
          echo "### üìä Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Lessons**: $(find public/lessons -name \"*.md\" -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Quizzes**: $(find public/content/quizzes -name \"*-quiz.json\" -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **HF Token**: ${{ steps.validate_token.outcome == 'success' && '‚úÖ Valid' || '‚ö†Ô∏è Check failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PWA Manifest**: ‚úÖ Valid" >> $GITHUB_STEP_SUMMARY
